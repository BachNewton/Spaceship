<!DOCTYPE html>
<html>

<head>
    <title>Spaceship</title>

    <style>
        body {
            background-color: black;
        }

        canvas {
            border: 1px solid white;
        }
    </style>
</head>

<body>
    <canvas id="canvas" width="1280" height="720"></canvas>

    <script>
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext("2d");
        var mouse = { x: -1, y: -1 };
        var mouseHeld = false;
        var keysHeld = {};
        var globalScale = 1;
        var MAX_DEPTH = 5;
        var grid = new Grid(-100000, 100000, -100000, 100000, 0);
        var debugMode = false;
        var debugKeyWasReleased = true;
        var debugKeyWasPressed = false;
        document.getElementById('canvas').addEventListener('mousedown', mouseDown);
        document.getElementById('canvas').addEventListener('mouseup', mouseUp);
        document.getElementById('canvas').addEventListener('mousemove', updateMousePosition);
        document.getElementById('canvas').addEventListener('wheel', scrollWheel);
        document.addEventListener('keydown', keyDown);
        document.addEventListener('keyup', keyUp);

        var spaceship = new Spaceship();
        var lasers = [];
        var asteroids = [];
        var asteroidImage = new Image();
        asteroidImage.src = "Resources/Images/asteroid.png";
        asteroids.push(new Asteroid(canvas.width * 0.2, canvas.height * 0.2, 1, 0, 1, Math.PI / 256));
        asteroids.push(new Asteroid(canvas.width * 0.8, canvas.height * 0.2, 0, 1, 1, Math.PI / 256));
        asteroids.push(new Asteroid(canvas.width * 0.2, canvas.height * 0.8, 0, -1, 1, Math.PI / 256));
        asteroids.push(new Asteroid(canvas.width * 0.8, canvas.height * 0.8, -1, 0, 1, Math.PI / 256));

        var density = 4000;
        for (var i = 0; i < density; i++) {
            asteroids.push(new Asteroid(Math.random() * 200000 - 100000, Math.random() * 200000 - 100000, Math.random() * 10 - 5, Math.random() * 10 - 5, Math.random() * 2.75 + 0.25, Math.PI / 256));
        }

        var FPS = 60;
        var INTERVAL = 1000 / FPS;
        var then = 0;
        draw();

        function draw(timestamp) {
            requestAnimationFrame(draw);

            var delta = timestamp - then;

            if (delta > INTERVAL) {
                then = timestamp - (delta % INTERVAL);
                frame();
            }
        }

        function frame() {
            var frameTime = new Stopwatch();

            // \
            if (keysHeld[220]) {
                debugKeyWasPressed = true;
                if (debugKeyWasReleased) {
                    debugMode = !debugMode;
                    debugKeyWasReleased = false;
                }
            } else {
                if (debugKeyWasPressed) {
                    debugKeyWasReleased = true;
                }
            }

            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.setTransform(globalScale, 0, 0, globalScale, -(globalScale - 1) * canvas.width / 2, -(globalScale - 1) * canvas.height / 2);
            ctx.translate(-spaceship.x + canvas.width / 2, -spaceship.y + canvas.height / 2);

            for (var i = 0; i < asteroids.length; i++) {
                asteroids[i].draw();

                if (debugMode) {
                    asteroids[i].drawHitBox('rgba(0,0,255,0.2)');
                }

                asteroids[i].move();
            }

            spaceship.draw();
            spaceship.update();
            spaceship.move();

            for (var i = 0; i < lasers.length; i++) {
                lasers[i].draw();
                lasers[i].move();

                var point = lasers[i].getCollisionPoint();
                var zone = grid.getZone(point.x, point.y);

                for (var j = 0; j < zone.length; j++) {

                    if (debugMode) {
                        zone[j].drawHitBox('rgba(0,255,0,0.2)');
                    }

                    if (lasers[i].collideWith(zone[j])) {
                        lasers.splice(i, 1);
                        i--;
                        var index = asteroids.indexOf(zone[j]);
                        asteroids.splice(index, 1);
                        zone.splice(j, 1);
                        break;
                    }
                }
            }

            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.fillStyle = 'white';
            ctx.font = '30px Arial';
            ctx.fillText('Remaining Asteroids: ' + asteroids.length.toLocaleString('en'), 4, 34);
            ctx.restore();

            if (debugMode) {
                grid.draw();
                frameTime.draw();
            }
        }

        function Spaceship() {
            this.x = canvas.width / 2;
            this.y = canvas.height / 2;
            this.thrust = 0.25;
            this.laserSpeed = 7;
            this.laserCooldown = 0;
            this.laserCooldownFilled = 15;
            this.xVel = 0;
            this.yVel = 0;
            this.rcsUp = false;
            this.rcsLeft = false;
            this.rcsDown = false;
            this.rcsRight = false;
            this.images = {
                body: { image: new Image() },
                rcs: { image: new Image() },
                gun: { image: new Image() },
                laser: { image: new Image() }
            };

            this.images.body.image.src = "Resources/Images/spaceship.png";
            this.images.body.scale = 0.2;

            this.images.rcs.image.src = "Resources/Images/rcs.png";
            this.images.rcs.scale = 0.2;

            this.images.gun.image.src = "Resources/Images/gun.png";
            this.images.gun.scale = 0.15;

            this.images.laser.image.src = "Resources/Images/laser.jpg";
            this.images.laser.scale = 0.5;

            this.draw = function () {
                if (this.rcsUp) {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(0);
                    ctx.drawImage(this.images.rcs.image, 0 - this.images.rcs.scale * this.images.rcs.image.width / 2, 0 - this.images.rcs.scale * this.images.rcs.image.height, this.images.rcs.scale * this.images.rcs.image.width, this.images.rcs.scale * this.images.rcs.image.height);
                    ctx.restore();
                }

                if (this.rcsRight) {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(Math.PI / 2);
                    ctx.drawImage(this.images.rcs.image, 0 - this.images.rcs.scale * this.images.rcs.image.width / 2, 0 - this.images.rcs.scale * this.images.rcs.image.height, this.images.rcs.scale * this.images.rcs.image.width, this.images.rcs.scale * this.images.rcs.image.height);
                    ctx.restore();
                }

                if (this.rcsDown) {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(Math.PI);
                    ctx.drawImage(this.images.rcs.image, 0 - this.images.rcs.scale * this.images.rcs.image.width / 2, 0 - this.images.rcs.scale * this.images.rcs.image.height, this.images.rcs.scale * this.images.rcs.image.width, this.images.rcs.scale * this.images.rcs.image.height);
                    ctx.restore();
                }

                if (this.rcsLeft) {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(Math.PI * 3 / 2);
                    ctx.drawImage(this.images.rcs.image, 0 - this.images.rcs.scale * this.images.rcs.image.width / 2, 0 - this.images.rcs.scale * this.images.rcs.image.height, this.images.rcs.scale * this.images.rcs.image.width, this.images.rcs.scale * this.images.rcs.image.height);
                    ctx.restore();
                }

                ctx.drawImage(this.images.body.image, this.x - this.images.body.scale * this.images.body.image.width / 2, this.y - this.images.body.scale * this.images.body.image.height / 2, this.images.body.scale * this.images.body.image.width, this.images.body.scale * this.images.body.image.height);

                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.getGunAngle() + Math.PI / 2);
                ctx.drawImage(this.images.gun.image, 0 - this.images.gun.scale * this.images.gun.image.width / 2, 0 - this.images.gun.scale * this.images.gun.image.height, this.images.gun.scale * this.images.gun.image.width, this.images.gun.scale * this.images.gun.image.height);
                ctx.restore();
            };

            this.update = function () {
                this.laserCooldown -= 1;

                // W
                if (keysHeld[87]) {
                    this.thrustUp();
                } else {
                    this.thrustUpStop();
                }

                // A
                if (keysHeld[65]) {
                    this.thrustLeft();
                } else {
                    this.thrustLeftStop();
                }

                // S
                if (keysHeld[83]) {
                    this.thrustDown();
                } else {
                    this.thrustDownStop();
                }

                // D
                if (keysHeld[68]) {
                    this.thrustRight();
                } else {
                    this.thrustRightStop();
                }

                // Mouse Held
                if (mouseHeld) {
                    if (this.laserCooldown <= 0) {
                        lasers.push(new Laser(this));
                        this.laserCooldown = this.laserCooldownFilled;
                    }
                }
            };

            this.thrustUp = function () {
                this.yVel -= this.thrust;
                this.rcsDown = true;
            };

            this.thrustUpStop = function () {
                this.rcsDown = false;
            };

            this.thrustLeft = function () {
                this.xVel -= this.thrust;
                this.rcsRight = true;
            };

            this.thrustLeftStop = function () {
                this.rcsRight = false;
            };

            this.thrustDown = function () {
                this.yVel += this.thrust;
                this.rcsUp = true;
            };

            this.thrustDownStop = function () {
                this.rcsUp = false;
            };

            this.thrustRight = function () {
                this.xVel += this.thrust;
                this.rcsLeft = true;
            };

            this.thrustRightStop = function () {
                this.rcsLeft = false;
            };

            this.move = function () {
                this.x += this.xVel;
                this.y += this.yVel;
            };

            this.getGunAngle = function () {
                return Math.atan2(mouse.y - canvas.height / 2, mouse.x - canvas.width / 2);
            };
        }

        function Laser(spaceship) {
            this.x = spaceship.x;
            this.y = spaceship.y;
            this.angle = spaceship.getGunAngle();
            this.xVel = spaceship.xVel + Math.cos(this.angle) * spaceship.laserSpeed;
            this.yVel = spaceship.yVel + Math.sin(this.angle) * spaceship.laserSpeed;
            this.images = {
                laser: spaceship.images.laser
            };

            this.draw = function () {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle + Math.PI / 2);
                ctx.drawImage(this.images.laser.image, 0 - this.images.laser.scale * this.images.laser.image.width / 2, 0 - this.images.laser.scale * this.images.laser.image.height, this.images.laser.scale * this.images.laser.image.width, this.images.laser.scale * this.images.laser.image.height);
                ctx.restore();
            };

            this.move = function () {
                this.x += this.xVel;
                this.y += this.yVel;
            }

            this.getCollisionPoint = function () {
                return {
                    x: this.x + this.images.laser.image.height * this.images.laser.scale * Math.cos(this.angle),
                    y: this.y + this.images.laser.image.height * this.images.laser.scale * Math.sin(this.angle)
                };
            };

            this.getDistanceTo = function (asteroid) {
                var point = this.getCollisionPoint();
                return Math.hypot(asteroid.y - point.y, asteroid.x - point.x);
            };

            this.collideWith = function (asteroid) {
                return this.getDistanceTo(asteroid) < asteroid.images.body.image.width * asteroid.images.body.scale / 2;
            };
        }

        function Asteroid(x, y, xVel, yVel, size, rotationalSpeed) {
            this.x = x;
            this.y = y;
            this.xVel = xVel;
            this.yVel = yVel;
            this.zone = grid.getZone(this.x, this.y);
            this.zoneIndex = this.zone.length;
            this.zone.push(this);
            this.size = size;
            this.rotation = 0;
            this.rotationalSpeed = rotationalSpeed;
            this.images = {
                body: { image: asteroidImage }
            };

            this.images.body.scale = this.size;

            this.draw = function () {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.drawImage(this.images.body.image, 0 - this.images.body.scale * this.images.body.image.width / 2, 0 - this.images.body.scale * this.images.body.image.height / 2, this.images.body.scale * this.images.body.image.width, this.images.body.scale * this.images.body.image.height);
                ctx.restore();
            };

            this.drawHitBox = function (color) {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.images.body.image.width * this.images.body.scale / 2, 0, 2 * Math.PI);
                ctx.fill();
            };

            this.move = function () {
                this.rotation += this.rotationalSpeed;
                this.moveTo(this.x + this.xVel, this.y + this.yVel);
            };

            this.moveTo = function (x, y) {
                var newZone = grid.getZone(x, y);

                if (this.zone != newZone) {
                    this.zone.splice(this.zoneIndex, 1);
                    this.zoneIndex = newZone.length;
                    newZone.push(this);
                    this.zone = newZone;
                }

                this.x = x;
                this.y = y;
            };
        }

        function mouseDown(evt) {
            mouseHeld = true;
        }

        function mouseUp(evt) {
            mouseHeld = false;
        }

        function keyDown(evt) {
            keysHeld[evt.keyCode] = true;
        }

        function keyUp(evt) {
            keysHeld[evt.keyCode] = false;
        }

        function updateMousePosition(evt) {
            var rect = canvas.getBoundingClientRect();
            mouse.x = evt.clientX - rect.left;
            mouse.y = evt.clientY - rect.top;
        }

        function scrollWheel(evt) {
            var magnitude = evt.deltaY;
            var zoomPower = 5000;

            if (magnitude < 0) {
                magnitude *= -1;
                globalScale *= 1 + (magnitude / zoomPower);
            } else {
                globalScale *= 1 - (magnitude / zoomPower);
            }
        }

        function Grid(leftBound, rightBound, topBound, bottomBound, depth) {
            this.centerX = (leftBound + rightBound) / 2;
            this.centerY = (topBound + bottomBound) / 2;
            this.leftBound = leftBound;
            this.rightBound = rightBound;
            this.topBound = topBound;
            this.bottomBound = bottomBound;

            if (depth >= MAX_DEPTH) {
                this.objects = [];
            } else {
                this.topLeft = new Grid(leftBound, this.centerX, topBound, this.centerY, depth + 1);
                this.topRight = new Grid(this.centerX, rightBound, topBound, this.centerY, depth + 1);
                this.bottomLeft = new Grid(leftBound, this.centerX, this.centerY, bottomBound, depth + 1);
                this.bottomRight = new Grid(this.centerX, rightBound, this.centerY, bottomBound, depth + 1);
            }

            this.getZone = function (x, y) {
                if (this.objects != undefined) {
                    return this.objects;
                } else {
                    if (x < this.centerX && y < this.centerY) {
                        return this.topLeft.getZone(x, y);
                    } else if (x >= this.centerX && y < this.centerY) {
                        return this.topRight.getZone(x, y);
                    } else if (x < this.centerX && y >= this.centerY) {
                        return this.bottomLeft.getZone(x, y);
                    } else {
                        return this.bottomRight.getZone(x, y);
                    }
                }
            };

            this.draw = function () {
                if (this.objects != undefined) {
                    ctx.strokeStyle = 'yellow';
                    ctx.lineWidth = 50;
                    ctx.strokeRect(this.leftBound, this.topBound, this.rightBound - this.leftBound, this.bottomBound - this.topBound);
                } else {
                    this.topLeft.draw();
                    this.topRight.draw();
                    this.bottomLeft.draw();
                    this.bottomRight.draw();
                }
            };
        }

        function Stopwatch() {
            this.startTime = performance.now();

            this.draw = function () {
                var time = Math.floor(performance.now() - this.startTime);

                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.fillStyle = 'lime';
                ctx.font = '15px Arial';
                ctx.fillText('Time / Frame: ' + time + 'ms', 4, canvas.height - 4);
                ctx.restore();
            };
        }
    </script>
</body>